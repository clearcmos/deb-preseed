# ======================================================================
# Debian 12 Automated Preseed — fully non‑interactive
# ======================================================================

### General debconf priority & frontend
d-i debconf/priority               string  critical
d-i debconf/frontend              string  noninteractive

### Locale & keyboard
d-i debian-installer/locale       string  en_US.UTF-8
d-i console-setup/ask_detect      boolean false
d-i keyboard-configuration/xkb-keymap select us

### Networking (DHCP)
d-i netcfg/enable                 boolean true
d-i netcfg/choose_interface       select  auto
d-i netcfg/dhcp_timeout           string   60
d-i netcfg/get_hostname           string   unassigned-hostname
d-i netcfg/get_domain             string

### Mirror settings
d-i mirror/country                string   manual
d-i mirror/http/hostname          string   deb.debian.org
d-i mirror/http/directory         string   /debian
d-i mirror/http/proxy             string

### Clock & timezone
d-i clock-setup/utc               boolean  true
d-i clock-setup/ntp               boolean  true
d-i time/zone                     string   UTC

### ----------------------------------------------------------------------------
### Disk partitioning — wipe & use entire first non‑removable disk (atomic)
### ----------------------------------------------------------------------------
# automatically pick the first non‑removable disk
d-i partman/early_command         string  \
  DISK=$(lsblk -dpno NAME,RM | awk '$2=="0"{print $1;exit}'); \
  debconf-set partman-auto/disk "$DISK"

# fully automated LVM-based (“atomic”) scheme
d-i partman-auto/method           string  regular
d-i partman-auto/choose_recipe    select  atomic
d-i partman/confirm_write_new_label boolean true
d-i partman/choose_partition      select  finish
d-i partman/confirm               boolean  true
d-i partman/confirm_nooverwrite   boolean  true
d-i partman-md/confirm            boolean  true

### Package selection
tasksel tasksel/first             multiselect ssh-server
d-i tasksel/skip-tasks            string   standard
d-i pkgsel/include                string   \
  apt-listchanges ca-certificates cifs-utils cockpit curl fzf git gnupg htop ipcalc jq \
  ncdu nmap openssh-server pkg-config python3 rclone rsync samba-common-bin smbclient \
  sudo timeshift wget
d-i pkgsel/upgrade                select   full-upgrade
popularity-contest popularity-contest/participate boolean false

### User & passwords
d-i passwd/root-login             boolean  true
d-i passwd/root-password          password ${rootpassword}
d-i passwd/root-password-again    password ${rootpassword}

d-i passwd/user-fullname          string   ${userfullname}
d-i passwd/username               string   ${username}
d-i passwd/user-password          password ${userpassword}
d-i passwd/user-password-again    password ${userpassword}
d-i passwd/user-default-groups    string   sudo

### Bootloader
d-i grub-installer/only_debian    boolean  true
d-i grub-installer/with_other_os  boolean  true
d-i grub-installer/bootdev        string   default

### Late command - clone repo, setup SSH keys and authorized_keys
d-i preseed/late_command string \
  in-target git clone https://github.com/clearcmos/deb-preseed /root/deb-preseed && \
  in-target bash -c "git clone https://github.com/clearcmos/deb-preseed /home/${username}/deb-preseed && chown -R ${username}:${username} /home/${username}/deb-preseed" && \
  in-target bash -c "mkdir -p /root/.ssh && chmod 700 /root/.ssh" && \
  in-target bash -c "echo '${ssh_authorized_key}' > /root/.ssh/authorized_keys && chmod 600 /root/.ssh/authorized_keys" && \
  in-target bash -c "mkdir -p /home/${username}/.ssh && chmod 700 /home/${username}/.ssh && chown ${username}:${username} /home/${username}/.ssh" && \
  in-target bash -c "echo '${ssh_authorized_key}' > /home/${username}/.ssh/authorized_keys && chmod 600 /home/${username}/.ssh/authorized_keys && chown ${username}:${username} /home/${username}/.ssh/authorized_keys" && \
  in-target bash -c "ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -N ''" && \
  in-target bash -c "ssh-keygen -t ed25519 -f /home/${username}/.ssh/id_ed25519 -N '' && chown ${username}:${username} /home/${username}/.ssh/id_ed25519 /home/${username}/.ssh/id_ed25519.pub"

### Finish up — reboot automatically
d-i debian-installer/exit/reboot  boolean  true
d-i finish-install/reboot_in_progress boolean true
d-i cdrom-detect/eject            boolean  true

